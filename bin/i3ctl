#!/bin/bash
workspaces_json() {
    i3-msg -t get_tree \
    | jq '.
        | recurse(.nodes[])
        | select(
            .type == "workspace" and
            .name != "__i3_scratch"
          )
    '
}
current_workspace_windows_json() {
    workspaces_json \
    | jq '.
        | select(.fullscreen_mode == 1)
        | recurse(.nodes[])
        | select(
            .type=="con" and
            .window != null
          )
    '
}
current_workspace_window_ids_json() {
    current_workspace_windows_json \
    | jq -s '.
        | [.[].window] as $all
        | (.[]|select(.focused).window) as $this
        | {
            all: $all,
            prev: $all|.[((length + (index($this) - 1)) % length)],
            this: $this,
            next: $all|.[((index($this) + 1) % length)]
          }
    '
}
next_window_id() { current_workspace_window_ids_json | jq .next; }
prev_window_id() { current_workspace_window_ids_json | jq .prev; }
next_window() { i3-msg "[id=$( next_window_id )]" focus; }
prev_window() { i3-msg "[id=$( prev_window_id )]" focus; }
# i3 needs path help to find jq
export PATH=$HOME/bin:$PATH
case $1 in
    debug)       current_workspace_window_ids_json ;;
    next-window) next_window   ;;
    prev-window) prev_window   ;;
    *)           exit 1        ;;
esac
